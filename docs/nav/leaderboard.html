<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../../../../favicon.ico">

  <title>Proof-of-Skill</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="../assets/bootstrap/boostrap.min.css">
  <link rel="stylesheet" href="../assets/styles/leaderboard.css">
  <link rel="import" href="./components/nav.component.html">
  <script src="../../assets/js/vendor/webcomponents/webcomponents-loader.js"></script>
  <script src="https://unpkg.com/rxjs/bundles/rxjs.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-with-addons.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="../assets/js/vendor/web3.min.js"></script>
  <script src="../assets/js/CONTACT_DATA.js"></script>
  <script src="../assets/js/connection.js"></script>
  <script src="../assets/js/leaderboard.js"></script>
</head>


<body>
  <pos-navigation></pos-navigation>

  <div class="container" id="root"></div>

  <script type="text/babel">
    var myWeb3, poolingInterval, userAccount, networkId, contract, userNames = {};

    class Results extends React.Component {
      constructor (props) {
        super(props);
        this.state = {};
      }
      componentDidMount() {
        hackatonResults.subscribe(results => this.setState({results}))
      }
      render(){
        let output;
        if (!this.state.results)
          return <p className="warning text-center">Loading results...</p>;
        else if (!this.state.results.length)
          return <p className="warning">No results yet...</p>;
        else return(
          <div>
            <p className="results-title">Результаты</p>
            <div className="table-responsive">
              <table className="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>Место</th>
                    <th>Участник</th>
                    <th>Счёт</th>
                    <th title="Задача №1 - JoiCasino">1</th>
                    <th title="Задача №2 - LEGO">2</th>
                    <th title="Задача №3 - FastFlow">3</th>
                    <th title="Задача №4 - Yohoho and a bottle of rum">4</th>
                    <th title="Задача №5 - Black pearl">5</th>
                    <th title="Задача №6 - Jack the Sparrow">6</th>
                    <th title="Задача №7 - Sir Henry Morgan">7</th>
                    <th>Решенные задачи</th>
                  </tr>
                </thead>
                <tbody>
                  {
                    this.state.results
                      .sort((a,b) => a.score < b.score)
                      .map((item, index) => <ResultsItem key={rnd(10)} {...item} index={index}/>)
                  }
                </tbody>
              </table>
            </div>
          </div>
        )
      }
    }

    class ResultsItem extends React.Component {
      constructor (props) {
        super();
      }
      render(){
        return(
          <tr>
            <td>{this.props.index+1}</td>
            <td className="name" title={this.props.userAddress}>{userNames[this.props.userAddress] || this.props.userAddress}</td>
            <td>{this.props.score}</td>
            <td title={date(this.props.tasks['JoiCasino'])}>{this.props.tasks['JoiCasino'] ? 'Да' : '-'}</td>
            <td title={date(this.props.tasks['LEGO'])}>{this.props.tasks['LEGO'] ? 'Да' : '-'}</td>
            <td title={date(this.props.tasks['FastFlow'])}>{this.props.tasks['FastFlow'] ? 'Да' : '-'}</td>
            <td title={date(this.props.tasks['Yohoho and a bottle of rum'])}>{this.props.tasks['Yohoho and a bottle of rum'] ? 'Да' : '-'}</td>
            <td title={date(this.props.tasks['Black pearl'])}>{this.props.tasks['Black pearl'] ? 'Да' : '-'}</td>
            <td title={date(this.props.tasks['Jack the Sparrow'])}>{this.props.tasks['Jack the Sparrow'] ? 'Да' : '-'}</td>
            <td title={date(this.props.tasks['Sir Henry Morgan'])}>{this.props.tasks['Sir Henry Morgan'] ? 'Да' : '-'}</td>
            <td title={this.props.timestampScore}>{Result.countFinishedTasks(this.props.tasks)}</td>
          </tr>
        )}
    }

    ReactDOM.render(
      <Results />,
      document.getElementById('root')
    );
    window.onload = startApp;

    function startApp() {
      try {
        myWeb3 = checkAndInstantiateWeb3();
        initConnection(myWeb3).then(({account, network}) => {
          userAccount = account;
          networkId = network;
          if (networkId !== 4 && networkId !== 5777 && networkId !== 1337) { throw Error(messages.notRinkeby); }
          contract = new myWeb3.eth.Contract(abi, contractAddress);
          poolingInterval = setInterval(getHackatonResults, 5000);
          console.log(`Connected to ${networkId === 4 ? 'Rinkeby' : 'Local'} network`);
          console.log('Your address ' + userAccount);
          console.log('Contract address ' + contract.options.address);
          contract.methods.getTeamName().call({from: account}).then(name => teamName.innerHTML = name);
        })
      } catch(err) {alert(err.message); console.error(err);}
    }
  </script>

  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="../assets/bootstrap/jquery-3.1.1.slim.min.js"></script>
  <script src="../assets/bootstrap/tether.min.js"></script>
  <script src="../assets/bootstrap/bootstrap.min.js"></script>

</body>

</html>
