<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../../../../favicon.ico">

  <title>BKX : CTF</title>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="../assets/bootstrap/boostrap.min.css">
  <link rel="stylesheet" href="../assets/styles/leaderboard.css">
  <script src="https://unpkg.com/rxjs/bundles/rxjs.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-with-addons.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="../assets/js/vendor/web3.min.js"></script>
  <script src="../assets/js/CONTACT_DATA.js"></script>
  <script src="../assets/js/connection.js"></script>
  <script src="../assets/js/leaderboard.js"></script>
</head>


<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">
      <h1>BKX : CTF</h1>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup"
      aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div style="color: #1e0010; font-weight: 700; font-size: 20px;" class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <div class="navbar-nav">
          <a class="nav-item nav-link" href="#">Tasks:</a>
          <a class="nav-item nav-link" href="tasks1.html">1</a>
          <a class="nav-item nav-link" href="tasks2.html">2</a>
          <a class="nav-item nav-link" href="tasks3.html">3</a>
          <a class="nav-item nav-link" href="tasks4.html">4</a>
          <a class="nav-item nav-link" href="tasks5.html">5</a>
          <a class="nav-item nav-link" href="tasks6.html">6</a>
          <a class="nav-item nav-link" href="tasks7.html">7</a>
          <a class="nav-item nav-link" href="tasks8.html">8</a>
          <a class="nav-item nav-link" href="tasks9.html">9</a>
          <a class="nav-item nav-link" href="tasks10.html">10</a>
          <a style="color: red;" class="nav-item nav-link" href="help.html">Help</a>
          <a style="color: rgb(28,168,252);" class="nav-item nav-link" href="leaderboard.html">Leaderboard<span class="sr-only">(current)</span></a>
          <a style="color: rgb(28,168,252);" class="nav-item nav-link" href="prize.html">WINNERS</a>
          <a style="color: black; float: right" class="nav-item nav-link" id="teamName"></a>
      </div>
    </div>
  </nav>

  <div class="container" id="root"></div>

  <script type="text/babel">
    var myWeb3, poolingInterval, userAccount, networkId, contract, userNames = {};

    class Results extends React.Component {
      constructor (props) {
        super(props);
        this.state = {};
      }
      componentDidMount() {
        hackatonResults.subscribe(results => this.setState({results}))
      }
      render(){
        let output;
        if (!this.state.results)
          return <p className="warning text-center">Loading results...</p>;
        else if (!this.state.results.length)
          return <p className="warning text-center">No results yet...</p>;
        else return(
          <div>
            <p className="results-title">Results</p>
            <div className="table-responsive">
              <table className="table table-striped table-sm" id="tableX">
                <thead>
                  <tr>
                    <th>Place</th>
                    <th>Participant</th>
                    <th>Score</th>
                    <th title="Task №1 - JoiCasino">1</th>
                    <th title="Task №2 - LEGO">2</th>
                    <th title="Task №3 - FastFlow">3</th>
                    <th title="Task №4 - Yohoho and a bottle of rum">4</th>
                    <th title="Task №5 - Black pearl">5</th>
                    <th title="Task №6 - Jack the Sparrow">6</th>
                    <th title="Task №7 - Sir Henry Morgan">7</th>
                    <th title="Task №8 - Kamikaze">8</th>
                    <th title="Task №9 - Vault">9</th>
                    <th title="Task №10 - DoubleTapVote">10</th>
                    <th>Solved tasks</th>
                  </tr>
                </thead>
                <tbody>
                  {
                    this.state.results
                      //.sort((a,b) => a.score < b.score)
                      .map((item, index) => <ResultsItem key={rnd(10)} {...item} index={index}/>)
                  }
                </tbody>
              </table>
            </div>
          </div>
        )
      }
    }

    class ResultsItem extends React.Component {
      constructor (props) {
        super();
      }
      render(){
        if(this.props.place) {
          return(
            <tr>
              <td>{this.props.place}</td>
              <td className="name" title={this.props.userAddress}>{this.props.userName || this.props.userAddress}</td>
              <td>{this.props.score}</td>
              <td title={date(this.props.tasks['JoiCasino'])}>{this.props.tasks['JoiCasino'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['LEGO'])}>{this.props.tasks['LEGO'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['FastFlow'])}>{this.props.tasks['FastFlow'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['Yohoho and a bottle of rum'])}>{this.props.tasks['Yohoho and a bottle of rum'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['Black pearl'])}>{this.props.tasks['Black pearl'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['Jack the Sparrow'])}>{this.props.tasks['Jack the Sparrow'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['Sir Henry Morgan'])}>{this.props.tasks['Sir Henry Morgan'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['Kamikaze'])}>{this.props.tasks['Kamikaze'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['Vault'])}>{this.props.tasks['Vault'] ? 'Yes' : '-'}</td>
              <td title={date(this.props.tasks['DoubleTapVote'])}>{this.props.tasks['DoubleTapVote'] ? 'Yes' : '-'}</td>
              <td title={this.props.timestampScore}>{Result.countFinishedTasks(this.props.tasks)}</td>
            </tr>
          )
        } else {
          return(
            <tr>
              <td>...</td>
              <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
            </tr>
          )
        }
      }
    }

    ReactDOM.render(
      <Results />,
      document.getElementById('root')
    );
    window.addEventListener('load', function() {
      startApp();
    });

    function startApp() {
      try {
        const turnOfConnectionCheck = true;
        const options = '&top=20&delta=1';
        const api = 'https://ctf-cache.bankex.team/leaders?';
        // const api = 'http://127.0.0.1:7000/leaders?';
        let address = '', url;
        myWeb3 = checkAndInstantiateWeb3();
        initConnection(myWeb3, turnOfConnectionCheck).then(async({account, network}) => {
          userAccount = account;
          networkId = network;
          if (userAccount) {
            if (networkId !== 4 && networkId !== 5777 && networkId !== 1337) { throw Error(messages.notRinkeby); }
            contract = new myWeb3.eth.Contract(abi, contractAddress);
            address = 'address='+ await getTeamAddressByUserAddress(contract, userAccount);
            console.log('Contract address ' + contract.options.address)
            console.log(`Connected to ${networkId === 4 ? 'Rinkeby' : 'Local'} network`);
            console.log('Your address ' + userAccount);
          }
          url = api+address+options;
          const request = new Request(url, {
            method: 'get',
            headers: {
                Accept: 'application/json'
            }
          });
          fetchData(request);
          poolingInterval = setInterval(fetchData.bind(this, request), 5000);
        })
      } catch(err) {
        debugger
        alert(err.message);
        console.error(err);

      }
    }

  </script>

  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="../assets/bootstrap/jquery-3.1.1.slim.min.js"></script>
  <script src="../assets/bootstrap/tether.min.js"></script>
  <script src="../assets/bootstrap/bootstrap.min.js"></script>

</body>

</html>
